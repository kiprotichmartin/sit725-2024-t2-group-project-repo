<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta Tags -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Add this in the <head> section -->
    <!--<meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com; style-src 'self' https://cdnjs.cloudflare.com; img-src 'self' data:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' http://localhost:5000"
    />-->
    <title>Register - YourAppName</title>

    <!-- MaterializeCSS CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />

    <!-- Material Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- Custom Styles -->
    <style>
      .container {
        /*margin-top: 50px;*/
        max-width: 500px;
      }
      .card-panel {
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="nav-wrapper teal lighten-1">
      <div class="container">
        <a href="index.html" class="brand-logo">YourAppName</a>
        <a href="#" data-target="mobile-nav" class="sidenav-trigger"
          ><i class="material-icons">menu</i></a
        >
        <ul class="right hide-on-med-and-down">
          <li class="active"><a href="register.html">Register</a></li>
          <li><a href="login.html">Login</a></li>
        </ul>
      </div>
    </nav>

    <!-- Mobile Navigation -->
    <ul class="sidenav" id="mobile-nav">
      <li class="active"><a href="register.html">Register</a></li>
      <li><a href="login.html">Login</a></li>
    </ul>

    <!-- Registration Form -->
    <div class="container">
      <h4 class="center-align">Register</h4>
      <div class="card-panel">
        <form id="registerForm">
          <div class="input-field">
            <!-- <i class="material-icons prefix">person</i> -->
            <input id="name" type="text" class="validate" required />
            <label for="name">Name</label>
            <span class="helper-text" data-error="Name is required"></span>
          </div>
          <div class="input-field">
            <!-- <i class="material-icons prefix">email</i> #} -->
            <input id="email" type="email" class="validate" required />
            <label for="email">Email</label>
            <span class="helper-text" data-error="Invalid email"></span>
          </div>
          <div class="input-field">
            <!-- <i class="material-icons prefix">lock</i> -->
            <input id="password" type="password" class="validate" required />
            <label for="password">Password</label>
            <span
              class="helper-text"
              data-error="Password must be at least 6 characters"
            ></span>
          </div>
          <div class="input-field">
            <!-- <i class="material-icons prefix">lock_outline</i> -->
            <input
              id="confirmPassword"
              type="password"
              class="validate"
              required
            />
            <label for="confirmPassword">Confirm Password</label>
            <span
              class="helper-text"
              data-error="Passwords do not match"
            ></span>
          </div>
          <div class="center-align">
            <button
              class="btn waves-effect waves-light teal"
              type="submit"
              name="action"
            >
              Register
            </button>
          </div>
        </form>
      </div>
      <p class="center-align">
        Already have an account? <a href="login.html">Login here</a>
      </p>
    </div>

    <!-- MaterializeCSS JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <!-- Include Config -->
    <script src="config.js"></script>

    <!-- Custom Scripts -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize Sidenav for mobile navigation
        const elems = document.querySelectorAll(".sidenav");
        M.Sidenav.init(elems);

        // Check if user is already logged in
        const token = localStorage.getItem("token");
        if (token) {
          window.location.href = "dashboard.html";
        }
      });

      // Form submission handler
      document
        .getElementById("registerForm")
        .addEventListener("submit", registerUser);

      async function registerUser(e) {
        e.preventDefault();

        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        // Client-side validation
        if (name.length < 2) {
          M.toast({
            html: "Name must be at least 2 characters",
            classes: "red",
          });
          return;
        }

        if (!validateEmail(email)) {
          M.toast({ html: "Please enter a valid email", classes: "red" });
          return;
        }

        if (password.length < 6) {
          M.toast({
            html: "Password must be at least 6 characters",
            classes: "red",
          });
          return;
        }

        if (password !== confirmPassword) {
          M.toast({ html: "Passwords do not match", classes: "red" });
          return;
        }

        try {
          const response = await fetch(`${CONFIG.API_BASE_URL}/api/users`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name, email, password }),
          });

          const data = await response.json();

          if (response.ok) {
            // Store token securely
            localStorage.setItem("token", data.token);
            window.location.href = "dashboard.html";
          } else {
            // Display error messages from backend
            if (data.errors) {
              data.errors.forEach((error) =>
                M.toast({ html: error.msg, classes: "red" })
              );
            } else {
              M.toast({
                html: data.msg || "Registration failed",
                classes: "red",
              });
            }
          }
        } catch (error) {
          console.error("Error:", error);
          M.toast({ html: "An error occurred", classes: "red" });
        }
      }

      function validateEmail(email) {
        const re =
          /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@(([^<>()[\]\.,;:\s@"]+\.)+[^<>()[\]\.,;:\s@"]{2,})$/i;
        return re.test(String(email).toLowerCase());
      }
    </script>
  </body>
</html>
